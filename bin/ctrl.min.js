(function(){var n,t,r,e,u,l,a=function(n,t){return function(){return n.apply(t,arguments)}};r=function(n){return Array.prototype.slice.call(n)},l=function(n){return null!=n&&Array.isArray(n)},t={next:function(n,t){var e;return n.steps=r(n.steps),e=-1,n.next=function(){var t;return e++,t=[n].concat(r(arguments)),e>=n.steps.length?n.callback.apply(null,t):n.steps[e].apply(null,t)},t()},spawn:function(n,t){var e,u,l;return l=null,e=function(){function n(n,t){this.callback=t,this.spawn=a(this.spawn,this),this.threadCount=-1,this.returnedThreads=-1,this.returnValues={}}return n.prototype.spawn=function(){var n,t=this;return this.threadCount++,n=this.threadCount,function(){if(null!=t.returnValues[n])throw"A spawn's callback can not be called multiple times!";return t.returnValues[n]=function(){switch(arguments.length){case 0:return null;case 1:return arguments[0];default:return r(arguments)}}.apply(t,arguments),t.returnedThreads++,t.checkIfAllReturned()}},n.prototype.checkIfAllReturned=function(){return this.returnValues.length&&this.returnedThreads===this.threadCount?(this.callback.apply(null,r(this.returnValues)),l=null):void 0},n.prototype.doneSpawning=function(){return this.returnValues.length=this.threadCount+1,this.checkIfAllReturned()},n}(),u=n.next,n.spawn=function(){return l||(l=new e(n,u)),l.spawn()},n.next=function(){return null===l?u.apply(null,arguments):l.doneSpawning()},t()},errorHandler:function(n,t){var r;return n.options.errorHandler?(r=n.next,n.next=function(){try{return r.apply(null,arguments)}catch(t){return n.options.errorHandler(n,t)}},t()):(t(),void 0)},data:function(n,t){return n.data=null!=n.options.data?n.options.data:{},t()}},n=function(){function n(n){this.builders=n,this.run=a(this.run,this),l(this.builders)||(this.builders=r(arguments))}return n.prototype.run=function(n,e,u){var l,a,s;return null==e&&(e={}),null==u&&(u=function(){}),s={steps:n,options:e,callback:u},t=r(this.builders),l=-1,a=function(){return l++,l>=t.length?s.next():t[l](s,a)},a()},n}(),e=new n(t.next,t.spawn,t.data,t.errorHandler),u=e.run,u.builders=t,u.defaultCtrlRunner=e,u.CtrlRunner=n,"undefined"==typeof module?window.ctrl=u:module.exports=u}).call(this);